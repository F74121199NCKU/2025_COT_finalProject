services:
  ollama:
    volumes:
      - ollama:/root/.ollama
    container_name: ollama
    pull_policy: always
    tty: true
    restart: always
    image: ollama/ollama:latest

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    volumes:
      - open-webui:/app/backend/data
    ports:
      - "3000:8080"
    environment:
      - 'OLLAMA_BASE_URL=http://ollama:11434'
      - 'WEBUI_SECRET_KEY=t0p-s3cr3t'
      # é€™è£¡é–‹å•Ÿäº†è¨»å†ŠåŠŸèƒ½
      - ENABLE_SIGNUP=true
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: always

  pipelines:
    image: ghcr.io/open-webui/pipelines:main
    container_name: pipelines
    volumes:
      - ./pipelines:/app/pipelines  # <--- ç¢ºä¿é€™è¡Œå­˜åœ¨ï¼Œé€™ä»£è¡¨ã€Œä½¿ç”¨æˆ‘é›»è…¦ç¡¬ç¢Ÿè£¡çš„æª”æ¡ˆã€
    ports:
      - "9099:9099"
    environment:
      - PIPELINES_REQUIREMENTS_PATH=/app/pipelines/requirements.txt
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: always
volumes:
  ollama:
  open-webui:

# ==============================================================================
# ðŸ—ï¸ ç³»çµ±æž¶æ§‹è¨­è¨ˆèˆ‡æ±ºç­–èªªæ˜Ž (Architecture Design Rationale)
# ==============================================================================
# 
# 1. è³‡æºå„ªåŒ–ç­–ç•¥ (Resource Optimization)
#    - æ±ºç­–ï¼šè¨»è§£æŽ‰ Ollama æœå‹™ï¼Œæ”¹ç”¨ NCKU API Gatewayã€‚
#    - åŽŸå› ï¼šå¯¦é©—å®¤é›»è…¦æˆ–è¼•è–„ç­†é›»å¯èƒ½ç¼ºä¹ç¨ç«‹é¡¯å¡ (GPU)ï¼Œç„¡æ³•æµæš¢é‹è¡Œ 7B/20B åƒæ•¸æ¨¡åž‹ã€‚
#    - æ•ˆç›Šï¼šå°‡é‡åº¦é‹ç®—å¤–åŒ…çµ¦ä¼ºæœå™¨ï¼Œç¢ºä¿ WebUI æ“ä½œæµæš¢ä¸å¡é “ã€‚
#
# 2. é–‹ç™¼æ•ˆçŽ‡ç­–ç•¥ (Development Efficiency)
#    - æ±ºç­–ï¼šPipelines æœå‹™æŽ¡ç”¨ Volume æŽ›è¼‰ (./pipelines:/app/pipelines)ã€‚
#    - åŽŸå› ï¼šDocker é è¨­ç’°å¢ƒæ˜¯å°é–‰çš„ï¼Œæ¯æ¬¡ä¿®æ”¹ç¨‹å¼ç¢¼éƒ½éœ€è¦ Rebuild éžå¸¸è€—æ™‚ã€‚
#    - æ•ˆç›Šï¼šå¯¦ç¾ã€Œç†±é‡è¼‰ (Hot Reload)ã€ï¼Œåœ¨ VS Code ä¿®æ”¹ FSM é‚è¼¯å­˜æª”å¾Œï¼Œ
#            å®¹å™¨å…§éƒ¨å³æ™‚æ›´æ–°ï¼Œå¤§å¹…ç¸®çŸ­ Debug æ™‚é–“ã€‚
#
# 3. æœå‹™è§£è€¦ç­–ç•¥ (Service Decoupling)
#    - æ±ºç­–ï¼šé€éŽ Environment Variables åˆ†åˆ¥è¨­å®šå¤šå€‹ OpenAI API ä¾†æºã€‚
#    - åŽŸå› ï¼šå°‡ã€ŒUI å±•ç¤ºå±¤ã€(WebUI)ã€ã€Œæ¥­å‹™é‚è¼¯å±¤ã€(Pipelines) èˆ‡ã€ŒæŽ¨è«–å±¤ã€(API) åˆ†é›¢ã€‚
#    - æ•ˆç›Šï¼šæž¶æ§‹éˆæ´»ï¼Œæœªä¾†è‹¥è¦åˆ‡æ›æ¨¡åž‹ (å¦‚ GPT-4 æˆ– Gemini)ï¼Œåªéœ€ä¿®æ”¹è®Šæ•¸ï¼Œ
#            ç„¡éœ€æ›´å‹•æ ¸å¿ƒç¨‹å¼ç¢¼ã€‚
#
# 4. ç¶²è·¯é€šè¨Šç­–ç•¥ (Network Connectivity)
#    - æ±ºç­–ï¼šé…ç½® extra_hosts: "host.docker.internal:host-gateway"ã€‚
#    - åŽŸå› ï¼šDocker å®¹å™¨ç¶²è·¯é è¨­éš”é›¢ï¼Œé›£ä»¥å­˜å–å®¿ä¸»æ©Ÿ (Localhost) è³‡æºã€‚
#    - æ•ˆç›Šï¼šæ‰“é€šå®¹å™¨å…§å¤–ç¶²è·¯ï¼Œç¢ºä¿å„å€‹æœå‹™èˆ‡æœ¬æ©Ÿä¹‹é–“èƒ½ç„¡ç¸«æºé€šï¼Œ
#            é¿å… Connection Refused éŒ¯èª¤ã€‚
# ==============================================================================